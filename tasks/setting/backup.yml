---
- name: Set setting variables
  ansible.builtin.set_fact:
    setting_name: "{{ backup_setting.key }}"
    setting: "{{ backup_setting.value }}"
- name: Assert restic setting
  when: setting.restic is defined
  block:
    - name: Set test variables
      ansible.builtin.set_fact:
        restic_repo_type: "{{ setting.restic.repo_type | default(backup_restic_default_repo_type) }}"
        restic_forget_keep_type: "{{ setting.restic.forget_keep_type | default(backup_restic_forget_default_keep_type) }}"
    - name: Assert restic setting
      ansible.builtin.assert:
        that:
          - restic_repo_type in restic_allow_repo_types
          - restic_forget_keep_type in restic_allow_forget_keep_types
        quiet: true
- name: Create backup data directory
  ansible.builtin.file:
    path: "{{ backup_data_dir }}/{{ setting_name }}"
    state: directory
    owner: "{{ setting.user }}"
    mode: "0750"
- name: Create/update rclone setting
  when: setting.rclone is defined
  become: true
  become_user: "{{ setting.user }}"
  block:
    - name: Create rclone config directory
      ansible.builtin.file:
        path: ~/.config/rclone
        state: directory
        mode: "0755"
    - name: Create/update rclone setting
      ansible.builtin.blockinfile:
        path: ~/.config/rclone/rclone.conf
        content: |
          {% for rclone_setting in setting.rclone | dict2items %}
          [{{ rclone_setting.key }}]
          {% for option_name, option_value in rclone_setting.value.items() %}
          {{ option_name }} = {{ option_value }}
          {% endfor %}
          {% endfor %}
        mode: "0600"
        create: true
      no_log: true
- name: Generate backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: "{{ backup_script_dir }}/{{ setting_name }}"
    owner: "{{ setting.user }}"
    mode: "0700"
  no_log: true
  register: backup_script_result
- name: Set backup cron jobs
  ansible.builtin.cron:
    user: "{{ setting.user }}"
    name: role:backup/setting:{{ setting_name }}
    job: "{{ backup_script_result.dest }}"
    month: "{{ setting.cron.month | default(omit) }}"
    day: "{{ setting.cron.day | default(omit) }}"
    hour: "{{ setting.cron.hour | default(omit) }}"
    minute: "{{ setting.cron.minute | default(omit) }}"
    weekday: "{{ setting.cron.weekday | default(omit) }}"
    disabled: "{{ setting.cron.disabled | default(false) }}"
